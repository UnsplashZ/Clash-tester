version: '3.8'

services:
  # ------------------------------------------------
  # 1. 生产者：定时测试节点并生成 JSON
  # ------------------------------------------------
  tester:
    build: .
    container_name: clash-tester-worker
    restart: unless-stopped
    environment:
      # ⚠️ 替换为你的订阅链接
      - SUB_URL=https://example.com/api/v1/client/subscribe?token=your_token
      # 检测间隔 (秒)，默认 1 小时
      - INTERVAL=3600
      - TZ=Asia/Shanghai
    volumes:
      # 挂载名为 shared_data 的 Docker Volume 到容器内的 /data
      - shared_data:/data

  # ------------------------------------------------
  # 2. 暴露者：提供 HTTP 访问接口
  # ------------------------------------------------
  server:
    image: nginx:alpine
    container_name: clash-tester-server
    restart: unless-stopped
    ports:
      # 外部访问端口
      - "8080:80"
    volumes:
      # 只读挂载同一个 Volume 到 Nginx 的 Web 根目录
      - shared_data:/usr/share/nginx/html:ro
      # 可选：挂载自定义 Nginx 配置以禁用缓存
      # - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - tester

volumes:
  shared_data:
